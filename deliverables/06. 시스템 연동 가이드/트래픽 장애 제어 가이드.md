# 트래픽 장애 제어 가이드



 ### 개요

![20190318110408](C:\Users\heras\Desktop\capture\20190318110408.png)

컨테이너 클러스터 환경에서 어플리케이션은 Micro Services 간에 트래픽이 자주 발생한다. (기존 VM 장비의 WAS 인스턴스에서 여러가지 서비스가 monolic하게 동작하였던 것과 비교하여 보자.) 위 그림을 예시로 supplier 서버에 장애가 생겨 항상 Timeout이 발생하는 경우, supplier 서버를 호출한 client 서버는 Timeout이 발생할 때까지 응답이 밀리게 된다. 응답이 밀리는 동안 요청이 계속 쌓여 결국 client 서버까지 요청이 과하게 밀려 장애가 발생할 수 있다. 이러한 상황에 circuit breaker를 두어 장애 전파를 막을 수 있다.

Micro Service Architecture에서 Micro Services간 트래픽이 많고 트래픽에 대한 관리가 중요하다. circuit breaker를 두어 Micro Services간 장애 전파 방지를 할 수 있다. 그러나  circuit breaker를 실제 적용함에 있어 쓰레드 개수 및 세마포어 사용여부, 캐싱 여부 등에 따라 성능 최적화 작업에 주의해야 한다.



### Spring boot

#### dependency 추가

```xml
<properties>
    <spring-cloud.version>Greenwich.SR1</spring-cloud.version>
</properties>

<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
    </dependency>
</dependencies>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```



#### application.yaml 추가 (전역 설정)

```yaml
hystrix:
  command:
    default:
      execution.isolation.thread.timeoutInMilliseconds: 5000
      metrics.rollingStats.timeInMilliseconds: 10000
      circuitBreaker.requestVolumeThreshold: 20
      circuitBreaker.errorThresholdPercentage: 50
      circuitBreaker.sleepWindowInMilliseconds: 5000
  threadpool:
    default:
      coreSize: 10
```

- execution.isolation.thread.timeoutInMilliseconds

Hystrix 가 적용된 메서드의 타임아웃을 지정한다. 이 타임아웃 내에 메서드가 완료되지못하면 서킷브레이커가 닫혀있다고 하더라도 fallback 메서드가 호출된다. 보통 외부 API 를 호출하게되면 RestTemplate 과 같은 http client에도 connect, read timeout 등을 지정하게하는데 hystrix timeout은 이를 포함하고 여유를 좀 더 두어 잡는다. 기본값은 1초(1000)



- metrics.rollingStats.timeInMilliseconds

서킷 브레이커가 열리기위한 조건을 체크할 시간이다. 아래에서 살펴볼 몇가지 조건들과 함께 조건을 정의하게되는데 "10초간 50% 실패하면 서킷 브레이커 발동" 이라는 조건이 정의되어있다면 여기서 10초를 맡는다. 기본값은 10초(10000)



- circuitBreaker.requestVolumeThreshold

서킷 브레이커가 열리기 위한 최소 요청조건이다. 즉 이 값이 20으로 설정되어있다면 10초간 19개의 요청이 들어와서 19개가 전부 실패하더라도 서킷 브레이커는 열리지않는다. 기본값은 20



- circuitBreaker.errorThresholdPercentage

서킷 브레이커가 발동할 에러 퍼센트를 지정한다. 기본값은 50



- circuitBreaker.sleepWindowInMilliseconds

서킷 브레이커가 열렸을때 얼마나 지속될지를 설정한다. 기본값은 5초(5000)



1. circuit health check를 위한 최소한의 요청이 있을 때(`HystrixCommandProperties.circuitBreakerRequestVolumeThreshold()`)
2. 그리고, 지정한 오류율을 초과했을 때(`HystrixCommandProperties.circuitBreakerErrorThresholdPercentage()`)
3. 회로의 상태를 `CLOSED`에서 `OPEN`으로 변경
4. 회로가 열린 동안, 모든 요청에 대해서 fallback method을 바로 실행
5. 일정 시간이 지난 후(`HystrixCommandProperties.circuitBreakerSleepWindowInMilliseconds()`), 하나의 요청을 원래 method로 실행(`HALF OPEN`). 이 요청이 실패한다면 `OPEN`으로 두고, 이 요청이 성공한다면 `CLOSED`로 상태를 변경. 다시 1번으로 돌아감.

# 기본 설정

- `metrics.rollingStats.timeInMilliseconds` : 오류 감시 시간, 기본값 10초
- `circuitBreaker.requestVolumeThreshold` : 감시 시간 내 요청 수, 기본값 20
- `circuitBreaker.errorThresholdPercentage` : 요청 대비 오류율, 기본값 50

기본 설정을 풀어서 설명하면 다음과 같다

> 감시시간 내(30초)에, 20번 이상의 요청이 있었고, 그 중에서 오류율이 50% 이상일 때 Circuit Breaker가 작동한다(circuit open)
> 감시 시간 내에 요청이 반드시 20번 이상이 있어야 회로가 열림. 30초 동안 요청이 19번이었고 모두 실패했어도 Circuit Breaker는 작동하지 않는다



### Istio









